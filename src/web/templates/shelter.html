<!DOCTYPE html>
<html lang="nl">
{% extends "layout.html" %}
{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename = 'lib/bower/d3/d3.min.js') }}"></script>
	<script src="{{ url_for('static', filename = 'lib/bower/leaflet/dist/leaflet.js') }}"></script>
	<script src="{{ url_for('static', filename = 'lib/bower/leaflet-image/leaflet-image.js') }}"></script>
	<link href="{{ url_for('static', filename = 'lib/bower/leaflet/dist/leaflet.css') }}" rel="stylesheet" media="screen" />
    {% endblock %}
{% block wrapper_start %}
<div id="wrapper">
{% endblock %}
{% block content %}
        <section class="shelterheader">
            <div class="content">
                <h1 id="shelter-name">[UNKNOWN NAME]</h1>
				<i class="fa fa-print print-image" aria-hidden="true" onClick="window.print()"></i>
            </div>
        </section>
		<section class="shelter-main-image">
                <img id="coverpictureprint" src="" />
            </section>
        <section id="coverpicture" class="shelterimg" onclick="modalOpen()">
			<div class="dots">
                <div class="dot selected"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </section>
		<section>
            <div class="details">
				<h3>Identification</h3>
				<div id="location-image" class="location-image"></div>
			    <div id="location-map" class="location-map"></div>
				<div class="content">
					<table id="identification">
						<tr>
							<td>No data available in this category</td>
						</tr>
					</table>
				</div>
			</div>
        </section>
		<section class="details details-1">
            <div class="content">
                <h3>General</h3>
                <table id="general">
					<tr>
						<td>No data available in this category</td>
					</tr>
				</table>
            </div>
        </section>
        <section class="details details-2">
            <div class="content">
                <h3>Disaster & Response</h3>
                <table id="disasterresponse">
					<tr>
						<td>No data available in this category</td>
					</tr>
				</table>
            </div>
        </section>

        <section class="details details-1">
            <div class="content">
                <h3>Site</h3>
                <table id="site">
					<tr>
						<td>No data available in this category</td>
					</tr>
				</table>
            </div>
        </section>
		
		 <section class="details details-2">
            <div class="content">
                <h3>Foundation</h3>
                <table id="foundation">
					<tr>
						<td>No data available in this category</td>
					</tr>
				</table>
            </div>
        </section>
		
		<div class="mymodal" id="infoDialog">
			<div class="content page1" id="modalcontent">
				<div class="page page1">
						<div class="mylabel" id="myModalLabel"><span id="infoDialogTitle"></span></div>
						<div align="center" id="listOfPictures"></div>
					
						<div class="buttons">
							<div onclick="infoDialogClose()" class="button button-light"><i class="fa fa-times"></i><span class="text">Close</span></div>
						</div>
				</div>
			</div>
		</div>
		
		
		
{% endblock %}

{% block footer %}
		<div class="mymodal">
            <div class="mymodal-close" onclick="modalClose()"></div>
            <div class="swipe">
                <div id="modalIdentificationPanes" class="panes"></div>
                <div id="modalIdentificationDots" class="dots"></div>
            </div>
        </div>
		
	<script type="text/javascript">
        var wrapper = document.getElementById("wrapper")
        var modalOpen = function(){
            wrapper.className = "modal-open modal-open-dark"
        }
        var modalClose = function(){
            wrapper.className = ""
        }
    </script>

    <script src="{{ url_for('static', filename = 'js/hammer.min.js') }}"></script>
	<script src="{{ url_for('static', filename = 'js/swipe.js') }}"></script>
		
    {{ super() }}
	
	<script type="text/javascript" class="source">
		var shelter_id = {{shelter_id}};

		d3.json('/api/v0.2/shelters/' + shelter_id + '?format=prettytext', function (error, data) {
		  
			
			// render the table(s)
			
			if(typeof data[shelter_id]['Site'] !== 'undefined') {
				var site = data[shelter_id]['Site']['Attributes'];
				$("#site").empty();
				tabulate('#site', site, d3.keys(site));
			}
			
			if(typeof data[shelter_id]['General'] !== 'undefined') {
				var general = data[shelter_id]['General']['Attributes'];
				$("#general").empty();
				tabulate("#general", general, d3.keys(general));
			}
			
			if(typeof data[shelter_id]['Disaster & Response'] !== 'undefined') {
				var disasterresponse = data[shelter_id]['Disaster & Response']['Attributes'];
				$("#disasterresponse").empty();
				tabulate("#disasterresponse", disasterresponse, d3.keys(disasterresponse));
			}
			
			if(typeof data[shelter_id]['Foundation'] !== 'undefined') {
				var foundation = data[shelter_id]['Foundation']['Attributes'];
				$("#foundation").empty();
				tabulate("#foundation", foundation, d3.keys(foundation));
			}
			
			if(typeof data[shelter_id]['Identification'] !== 'undefined') {
				// Set shelter name
				$('#shelter-name').text(data[shelter_id]['Identification']['Attributes']['Name of shelter']);
				
				// add attributes
				var identification = data[shelter_id]['Identification']['Attributes'];
				$("#identification").empty();
				tabulate("#identification", identification, d3.keys(identification));
			
				// Get coordinates for this shelter
				var lat = data[shelter_id]['Identification']['Attributes']['GPS Latitude'];
				var lon = data[shelter_id]['Identification']['Attributes']['GPS Longitude'];
				
				// Initiate leaflet map
				var map = L.map('location-map', {tap:false}).setView([lat, lon], 13);
				
				// Add OSM base layer
				L.tileLayer('http://a.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);
				
				// disable dragging and scrolling for mobile view
				map.scrollWheelZoom.disable();
				map.dragging.disable();
				
				// add location of shelter to map
				L.marker([lat, lon]).addTo(map);
					
				// add pictures
				addCoverPictures('#coverpicture', '#coverpictureprint', data[shelter_id]['Identification']);
				addSwipePictures('#modalIdentification', data[shelter_id]['Identification']);
				
				// convert map to image for better printing
				leafletImage(map, function(err, canvas) {
					// now you have canvas
					// example thing to do with that canvas:
					$('#location-image').prepend('<img id="location-image-picture" src="'+ canvas.toDataURL() + '" />')		
				});
			}
		});
		
		function addCoverPictures(coverpicture, printpicture, section){
			if(typeof section['Cover'] !== 'undefined' && section['Cover'].length > 0) {
				$(coverpicture).css("background-image", "url('/" + section['Cover'][0] + "')");	
				$(printpicture).attr("src", "/" + section['Cover'][0]);					
			}
		}
		
		function addSwipePictures(elementId, section){
			if(typeof section['Pictures'] !== 'undefined') {
			
				//merge arrays
				var d = $.merge(section.Cover, section.Pictures);
				
				// add panes
				d3.select(elementId + "Panes")
				   .selectAll("div")
				   .data(d)
				   .enter()
				   .append("div")
					   .attr("class","pane")
					   .attr("style",function (d){ return "background-image:  url('/" + d + "')";});
				
				// add dots
				// TODO increment show id
				var dot = 0;
				
				d3.select(elementId + "Dots")
				   .selectAll("div")
				   .data(d)
				   .enter()
				   .append("div")
					   .attr("class","dot")
					   .attr("onclick",function (d){ 
						var r = "_swipe.show(" + dot + ",0,true)";
						dot++;
						return r;
					});
			}
		}

		function tabulate(table_id, d, columns) {

			// convert object keys to an attribute value pair
			var data = Object.keys(d).map(function(k) { return {attribute:k, value:d[k]} })
			
			var table = d3.select(table_id)
			var	tbody = table.append('tbody');

			// create a row for each object in the data
			var rows = tbody.selectAll('tr')
			  .data(data)
			  .enter()
			  .append('tr');

			// Add column with attribute names
			rows.append('th').append('b')
			    .text(function (d) { 
					return d.attribute; 
					
				});
			 
			// Add column with values
			rows.append('td')
					.text(function (d) { return d.value; })
				.append('span')
					.attr("class", function (d) { 
						// TODO test if attribute has drawing
						return "info attribute-multimedia-asset"})
					.attr("value", function (d) { return d.attribute;});
		}
	</script>
    <script type="text/javascript">
	
	$(document).ready(function() {
			$(document).on('click', '.attribute-multimedia-asset' , show_multimedia_assets);
		
			function retrieve_and_display_multimedia_asset(attributeName) {
				var filters = [{"name":"name","op":"eq","val": attributeName}];
				$.ajax({
					type: 'GET',
					url: '/api/attribute',
					contentType: "application/json",
					dataType: "json",
					data: {"q": JSON.stringify({"filters": filters})},
					success: function(result) {
						$('#listOfPictures').empty();
						if(result.objects.length > 0){
							result.objects[0].pictures.map(function(picture) {
								oImg = document.createElement("img");
								oImg.setAttribute('src', "{{ url_for('static', filename = 'pictures/attributes/en/')}}" + picture.file_name );
								oImg.setAttribute('alt', picture.file_name);
								oImg.setAttribute('title', picture.file_name);
								oImg.setAttribute('height', '600px');
								oImg.setAttribute('width', '600px');
								$('#listOfPictures').append(oImg);
								$('#listOfPictures').append(document.createElement("hr"));
							})
							$('#listOfPictures hr:last-child').remove();
							infoDialogOpen();
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						//document.getElementById("geolocation").innerHTML = XMLHttpRequest.responseText;
					}
					}); // ajax closed
			}

			function show_multimedia_assets(evt) {
				evt = evt || window.event; // The event that was fired
				var targ = evt.target || evt.srcElement; // the element that was clicked

				$('#infoDialogTitle').text("Description");
				var attrName = $(this).attr("value");

				retrieve_and_display_multimedia_asset(attrName);

			}
	});
		
	
</script>

<script type="text/javascript">
            var cnt = document.getElementById("modalcontent")
            var wrapper = document.getElementById("wrapper")
            var page = 1
            var infoDialogOpen = function(){
                wrapper.className = "modal-open"
            }
            var infoDialogClose = function(){
                wrapper.className = ""
                page = 1
                cnt.className = "content page1"
            }
    </script>
	
{% endblock %}
{% block wrapper_end %}
</div>
{% endblock %}